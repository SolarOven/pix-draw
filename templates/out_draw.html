<!DOCTYPE html>
<html>
<head>
	<title>pix draw--outtest</title>
	<style type="text/css">
		#draw{
			position: absolute;
			top: 0px;
			left: 0px;
			z-index: -10;
		}
		#grid{
			position: absolute;
			top: 0px;
			left: 0px;
			z-index: -5;
		}
		#output{
			top: 0px;
			left: 0px;
			width: 100px;
			height: 50px;
			z-index: 10;
			position: fixed;
		}
		#draw_name{
			position: fixed;
			top: 0px;
			left: 120px;
			z-index: 20;
			height: 20px;
			width: 240px;
		}
		#input{
			top: 50px;
			left: 0px;
			width: 100px;
			height: 50px;
			z-index: 10;
			position: fixed;
		}
	</style>
</head>
<body>

<form >
	<input id="draw_name" type="text" placeholder="Please input your file name First">	
</form>
<button id="input"  type="button" onclick="input_data()">input</button>
<button id="output" type="button" onclick="send_data()">output</button>
<canvas id="draw"></canvas>
<canvas id="grid"></canvas>

<script type="text/javascript">
	draw_name="";
	cell_len=20;
	draw=document.getElementById("draw");
	grid=document.getElementById("grid");
	
	width=grid.width=draw.width=window.innerWidth;
	height=grid.height=draw.height=window.innerHeight;
	
	ctx=draw.getContext("2d");
	grid_ctx=grid.getContext("2d");
	drawflag=false;
	data_load=false;
	init_grid_draw();


	//init the background-color and the grid-color
	function init_grid_draw(){
		ctx.fillStyle="rgb(140,140,140)";
		ctx.fillRect(0,0,width,height);

		grid_ctx.beginPath();

		grid_ctx.strokeStyle = 'rgba(255,255,255,0.5)'; 
		grid_ctx.lineWidth = 1; 
		for(i=0;i<width/cell_len;i++){
			grid_ctx.moveTo(i*cell_len,0);
			grid_ctx.lineTo(i*cell_len,height);
		}
		for(j=0;j<height/cell_len;j++){
			grid_ctx.moveTo(0,j*cell_len);
			grid_ctx.lineTo(width,j*cell_len);
		}
		grid_ctx.stroke();
	}
	//drawing event
	grid.onmousedown=function(event){
		ctx.fillStyle='rgb(0,0,230)';
		var x=parseInt(event.clientX/cell_len)*cell_len;
		var y=parseInt(event.clientY/cell_len)*cell_len
		ctx.fillRect(x,y,cell_len,cell_len);
		drawflag=true;
	}
	grid.onmousemove=function(event){
		if(drawflag!=true){
			return;
		}
		else{
			ctx.fillStyle='rgb(0,0,230)';
			var x=parseInt(event.clientX/cell_len)*cell_len;
			var y=parseInt(event.clientY/cell_len)*cell_len;
			ctx.fillRect(x,y,cell_len,cell_len);
		}
	}
	grid.onmouseup=function(){

		drawflag=false;
	}
	//output
	function get_json(){
	  var canva_tags=document.getElementsByTagName("canvas");
	  
	  var msg={};
	  msg["size"]=[parseInt(width/cell_len),parseInt(height/cell_len)];
  	  msg["name"]=draw_name;
	  /*
	  msg:{
	    "cav id1":[z-index,cav_color],
	    "cav id2":[z-index,cav_color],
	    ...
	  }

	  */
	  var i=0;
	  for(i=0;i<canva_tags.length-1;i++){//-1:不导出grid
	    var cur_cav=canva_tags[i];//对于每一个cav

	    var cav_info=window.getComputedStyle(cur_cav,null);

	    var cav_ctx=cur_cav.getContext("2d");

	    var cav_zindex=cav_info["z-index"];
	    var cav_id=cur_cav.id;

	    var cav_color=[];
	    var j=0;
	    var k=0;
	    for(j=0;j<parseInt(width/cell_len);j++){//对每一列
	      cav_color.push([]);//新建列
	      for(k=0;k<parseInt(height/cell_len);k++){//每一列的每一行
	        cav_color[j].push(cav_ctx.getImageData(j*cell_len,k*cell_len,1,1).data);
	      }
	    }
	    msg[cav_id]=[cav_zindex, cav_color];
	  }
	 return  msg;
	}
	function send_data() {
		draw_name=get_name();

		if(draw_name==""){
			alert("have not give the filename");
			return 0;
		}
		var data=get_json();
		var XHR = new XMLHttpRequest();
		var urlEncodedData = "";
		var urlEncodedDataPairs = [];
		var name;

		// 将数据对象转换为URL编码的键/值对数组。
		for(name in data) {
		urlEncodedDataPairs.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
		}

		// 将配对合并为单个字符串，并将所有%编码的空格替换为
		// “+”字符；匹配浏览器表单提交的行为。
		urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');

		// 定义成功数据提交时发生的情况
		XHR.addEventListener('load', function(event) {
		alert('save success');
		});
		// 定义错误提示
		XHR.addEventListener('error', function(event) {
		alert('faild');
		});

		// 建立我们的请求
		XHR.open('POST', 'http://127.0.0.1:5000/out');

		// 为表单数据POST请求添加所需的HTTP头
		XHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

		// 最后，发送我们的数据。
		XHR.send(urlEncodedData);
	}
	function get_name(){//return a value
		var input=document.getElementById("draw_name");
		return input.value;
	}
	//input
	function input_data(){

		get_data();
		var body=document.getElementsByTagName("body");
		var i,j,zindex,pix_value;
		var input_cav,input_ctx;
		for(var k in data_load){
			zindex = data_load[k][0]
			pix_value = data_load[k][1]
			
			if(k=="draw"){

				for(i=0;i<data_load[k][1].length;i++){
					for(j=0;j<data_load[k][1][0].length;j++){
						ctx.fillStyle='rgba('+String(data_load[k][1][i][j])+')';
						ctx.fillRect(i*cell_len,j*cell_len,cell_len,cell_len);
					}
				}
			}
		}

	}
	function get_data(){//to global var

		draw_name=get_name();
		if(draw_name==""){
			alert("have not give the filename");
			return 0;
		}
		var msg={"name":draw_name};
		var data=msg;

		var XHR = new XMLHttpRequest();
		var urlEncodedData = "";
		var urlEncodedDataPairs = [];
		var name;

		// 将数据对象转换为URL编码的键/值对数组。
		for(name in data) {
			urlEncodedDataPairs.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
		}

		// 将配对合并为单个字符串，并将所有%编码的空格替换为
		// “+”字符；匹配浏览器表单提交的行为。
		urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');
		// 建立我们的请求
		XHR.open('POST', 'http://127.0.0.1:5000/in',false);//false:wait the data loading
		// 为表单数据POST请求添加所需的HTTP头
		XHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

		XHR.onreadystatechange=function(){
			console.log(draw_name);
			if (XHR.readyState == 4 && XHR.status == 200) {//4:done 200:request success
                console.log("done and 200");
                var json = XHR.responseText;//获取到json字符串，还需解析
                data_load=JSON.parse(json);
            }
		};

		XHR.send(urlEncodedData);

	}

</script>
</body>
</html>